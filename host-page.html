<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ÁÆ°ÁêÜÊàëÂòÖÂ≥∂</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Nunito',sans-serif;background:#F5F5E8;color:#8B5A2B;padding:20px}
        .box{max-width:600px;margin:0 auto;background:white;padding:30px;border-radius:15px;border:2px solid #96C8A4}
        input,textarea,select{width:100%;padding:12px;margin:5px 0 15px 0;border:2px solid #ddd;border-radius:10px;box-sizing:border-box;font-family:inherit;font-size:1rem}
        label{font-weight:bold;color:#4A7A5C}
        .btn{width:100%;padding:15px;border:none;border-radius:10px;cursor:pointer;color:white;font-size:1.2rem}
        .green{background:#96C8A4} .red{background:#d9534f} .blue{background:#73a0c0}
        .lang-switcher { text-align: center; margin-bottom: 20px; font-size: 0.9rem; }
        .lang-switcher a { color: var(--ac-blue); text-decoration: none; padding: 0 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="lang-switcher">
        <a href="?lang=zh">‰∏≠Êñá</a> | <a href="?lang=en">English</a> | <a href="?lang=ja">Êó•Êú¨Ë™û</a>
    </div>
    <div style="text-align:center;margin-bottom:20px">
        <h1 data-i18n="title">‚úàÔ∏è ÁÆ°ÁêÜÊàëÂòÖÂ≥∂</h1>
        <a href="index.html" style="text-decoration:none;color:#73a0c0;font-weight:bold" data-i18n="back_home">‚Üê ËøîÈ¶ñÈ†Å</a>
    </div>
    <div class="box" id="content">Loading...</div>

    <script>
        const API_URL = "https://api.ttctv-105.cc";
        const user = JSON.parse(localStorage.getItem('acnh_user'));
        
        // --- I18n Script ---
        const translations = {
            'zh': {
                'title': '‚úàÔ∏è ÁÆ°ÁêÜÊàëÂòÖÂ≥∂', 'back_home': '‚Üê ËøîÈ¶ñÈ†Å', 'loading': 'Ê™¢Êü•‰∏≠...', 'conn_fail': 'ÈÄ£Á∑öÂ§±Êïó',
                'reg_host': 'ÁôªË®òÈñãÂ≥∂', 'dodo': 'Dodo Code‚Ñ¢', 'dodo_ph': '5‰Ωç Code', 'island_name': 'Â≥∂Âêç',
                'limit': 'ÂêåÊôÇ‰∏äÂ≥∂‰∫∫Êï∏ÈôêÂà∂', 'notice': '‚ö†Ô∏è ÈÄ≤Â≥∂Ê≥®ÊÑè‰∫ãÈ†Ö (È°ØÁ§∫Âú®ÊéíÈöäÂçÄ)', 'notice_ph': '‰æãÂ¶Ç: Âè™ÈôêÊ©üÂ†¥Èõ¢Èñã„ÄÅÁ¶ÅÁ©øÊΩõÊ∞¥Ë°£...',
                'note': 'ÂÇôË®ª (È°ØÁ§∫Âú®ÂàóË°®)', 'note_ph': '‰æãÂ¶Ç: Ë≥£Â§ßÈ†≠Ëèú 500ÔºÅ', 'confirm_btn': 'Á¢∫Ë™çÈñãÂ≥∂',
                'opening': 'ÈñãÊîæ‰∏≠...', 'limit_txt': 'ÈôêÂà∂‰∫∫Êï∏:', 'people': '‰∫∫', 'view_q': 'üëÅÔ∏è Ê™¢Ë¶ñÊéíÈöä', 'close_btn': '‚ö†Ô∏è Á´ãÂç≥ÈóúÂ≥∂',
                'confirm_close': 'Á¢∫ÂÆöÈóúÂ≥∂Ôºü'
            },
            'en': {
                'title': '‚úàÔ∏è Manage My Island', 'back_home': '‚Üê Back to Home', 'loading': 'Checking...', 'conn_fail': 'Connection Failed',
                'reg_host': 'Open Island', 'dodo': 'Dodo Code‚Ñ¢', 'dodo_ph': '5-digit Code', 'island_name': 'Island Name',
                'limit': 'Visitor Limit', 'notice': '‚ö†Ô∏è Notice (Shown in queue)', 'notice_ph': 'E.g., Leave via airport, No wetsuits...',
                'note': 'Note (Shown in list)', 'note_ph': 'E.g., Turnips @ 500!', 'confirm_btn': 'Open Island',
                'opening': 'Island Open...', 'limit_txt': 'Limit:', 'people': '', 'view_q': 'üëÅÔ∏è View Queue', 'close_btn': '‚ö†Ô∏è Close Island',
                'confirm_close': 'Are you sure you want to close the island?'
            },
            'ja': {
                'title': '‚úàÔ∏è Â≥∂„ÅÆÁÆ°ÁêÜ', 'back_home': '‚Üê „Éõ„Éº„É†„Å´Êàª„Çã', 'loading': 'Á¢∫Ë™ç‰∏≠...', 'conn_fail': 'Êé•Á∂öÂ§±Êïó',
                'reg_host': 'Â≥∂„ÇíÈñãÊîæ„Åô„Çã', 'dodo': '„Éë„Çπ„ÉØ„Éº„Éâ (Dodo Code‚Ñ¢)', 'dodo_ph': '5Ê°Å„ÅÆ„Ç≥„Éº„Éâ', 'island_name': 'Â≥∂Âêç',
                'limit': 'ÂêåÊôÇÂÖ•Â†¥‰∫∫Êï∞Âà∂Èôê', 'notice': '‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†Ö (ÂæÖÊ©üÂàó„Å´Ë°®Á§∫)', 'notice_ph': '‰æãÔºöÁ©∫Ê∏Ø„Åã„Çâ„ÅäÂ∏∞„Çä„Åè„Å†„Åï„ÅÑ„ÄÅ„Éû„É™„É≥„Çπ„Éº„ÉÑÁ¶ÅÊ≠¢...',
                'note': 'ÂÇôËÄÉ („É™„Çπ„Éà„Å´Ë°®Á§∫)', 'note_ph': '‰æãÔºö„Ç´„Éñ‰æ° 500„Éô„É´ÔºÅ', 'confirm_btn': 'Â≥∂„ÇíÈñã„Åè',
                'opening': 'ÈñãÊîæ‰∏≠...', 'limit_txt': 'ÂÆöÂì°:', 'people': '‰∫∫', 'view_q': 'üëÅÔ∏è ÂæÖÊ©üÂàó„ÇíË¶ã„Çã', 'close_btn': '‚ö†Ô∏è Â≥∂„ÇíÈñâ„ÇÅ„Çã',
                'confirm_close': 'Â≥∂„ÇíÈñâ„ÇÅ„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü'
            }
        };

        function getLanguage() {
            const urlLang = new URLSearchParams(window.location.search).get('lang');
            if (urlLang && translations[urlLang]) return urlLang;
            const browserLang = navigator.language.split('-')[0];
            return translations[browserLang] ? browserLang : 'zh';
        }
        
        function translatePage(lang) {
            const t = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.textContent = t[el.getAttribute('data-i18n')];
            });
             document.querySelectorAll('a').forEach(a => {
                if (a.href && !a.href.includes('javascript')) {
                    const url = new URL(a.href, window.location.href);
                    url.searchParams.set('lang', lang);
                    a.href = url.href;
                }
            });
        }

        const currentLang = getLanguage();
        const t = translations[currentLang];

        if(!user) window.location.href=`login.html?lang=${currentLang}`;

        const content = document.getElementById('content');
        document.addEventListener('DOMContentLoaded', () => {
            translatePage(currentLang);
            checkStatus();
        });

        async function checkStatus() {
            content.innerHTML = t.loading;
            try {
                const res = await fetch(`${API_URL}/my-status?email=${encodeURIComponent(user.email)}`);
                const json = await res.json();
                if(json.data) showClose(json.data); else showHost();
            } catch(e) { content.innerHTML = t.conn_fail; }
        }

        function showHost() {
            content.innerHTML = `
                <h3>${t.reg_host}</h3>
                <label>${t.dodo}</label>
                <input id="dodo" placeholder="${t.dodo_ph}" maxlength="5">
                <label>${t.island_name}</label>
                <input id="name" value="${user.username}ÁöÑÂ≥∂">
                <label>${t.limit}</label>
                <select id="maxUsers">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
                <label style="color:#e67e22">${t.notice}</label>
                <textarea id="notice" placeholder="${t.notice_ph}"></textarea>
                <label>${t.note}</label>
                <textarea id="note" placeholder="${t.note_ph}"></textarea>
                <button onclick="host()" class="btn green">${t.confirm_btn}</button>
            `;
        }

        function showClose(data) {
            content.innerHTML = `
                <h3 style="text-align:center;color:#4A7A5C">${t.opening}</h3>
                <p>${t.island_name}: ${data.island_name}</p>
                <p>${t.limit_txt} ${data.max_visitors} ${t.people}</p>
                <p style="font-size:1.5rem;color:#73a0c0;font-weight:bold;text-align:center">${data.dodo_code}</p>
                <a href="island.html?host=${encodeURIComponent(user.email)}&lang=${currentLang}" class="btn blue" style="display:block;text-align:center;text-decoration:none;box-sizing:border-box;margin-bottom:10px">${t.view_q}</a>
                <button onclick="closeIsland()" class="btn red">${t.close_btn}</button>
            `;
        }

        async function host() {
            const payload = {
                email: user.email, 
                islandName: document.getElementById('name').value,
                dodoCode: document.getElementById('dodo').value, 
                note: document.getElementById('note').value,
                maxVisitors: document.getElementById('maxUsers').value,
                notice: document.getElementById('notice').value
            };
            await fetch(`${API_URL}/host`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            checkStatus();
        }

        async function closeIsland() {
            if(!confirm(t.confirm_close)) return;
            await fetch(`${API_URL}/close`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email: user.email}) });
            checkStatus();
        }
    </script>
</body>
</html>
